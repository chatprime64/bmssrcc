<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cube Library</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #fff; color: #333; }
    h1 { text-align: center; color: #69a769; margin: 1rem 0; }
    table { width: 90%; margin: 1rem auto; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    th { background: #69a769; color: #fff; }
    button { padding: 0.4rem 0.8rem; border: none; border-radius: 4px; background: #69a769; color: #fff; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #workflow-bar { width:80%;margin:1rem auto;height:18px;background:#e5e5e5;border-radius:9px;overflow:hidden;display:none; }
    #workflow-progress { width:0%;height:100%;background:#69a769;transition:width 0.4s ease; }
  </style>
</head>
<body>
  <h1>Cube Library</h1>

  <table id="library-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Type</th>
        <th>Status</th>
        <th>Borrower</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="workflow-bar">
    <div id="workflow-progress"></div>
  </div>

  <script>
    // Load cubes from library.json
    async function loadLibrary() {
      const res = await fetch("admin/library.json");
      const cubes = await res.json();
      const tbody = document.querySelector("#library-table tbody");
      tbody.innerHTML = "";

      cubes.forEach(cube => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${cube.id}</td>
          <td>${cube.name}</td>
          <td>${cube.type}</td>
          <td>${cube.status}</td>
          <td>${cube.borrower_id || ""}</td>
          <td>
            ${cube.status === "available" 
              ? `<button onclick="borrowCube('${cube.id}', prompt('Enter your Student ID'))">Borrow</button>` 
              : `<button disabled>Not Available</button>`}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function borrowCube(itemId, studentId) {
      if (!studentId) return;
      const confirmed = confirm(`Do you want to borrow cube ${itemId}?`);
      if (!confirmed) return;

      // Show progress bar
      document.getElementById("workflow-bar").style.display = "block";
      document.getElementById("workflow-progress").style.width = "20%";

      // Trigger workflow dispatch
      const response = await fetch("https://api.github.com/repos/YOURUSER/YOURREPO/actions/workflows/borrow.yml/dispatches", {
        method: "POST",
        headers: {
          "Authorization": "token YOUR_PUBLIC_WORKFLOW_TOKEN", // safe if only workflow dispatch
          "Accept": "application/vnd.github+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          ref: "main",
          inputs: { itemId, studentId }
        })
      });

      if (!response.ok) {
        alert("Failed to trigger borrow workflow.");
        return;
      }

      pollWorkflowStatus();
    }

    async function pollWorkflowStatus() {
      const prog = document.getElementById("workflow-progress");
      const res = await fetch("https://api.github.com/repos/YOURUSER/YOURREPO/actions/runs");
      const data = await res.json();
      const latest = data.workflow_runs[0];

      if (latest.status === "queued") prog.style.width = "25%";
      else if (latest.status === "in_progress") prog.style.width = "75%";
      else if (latest.status === "completed") {
        prog.style.width = "100%";
        setTimeout(() => {
          document.getElementById("workflow-bar").style.display = "none";
          alert("Borrow confirmed! Cube is now active.");
          loadLibrary(); // reload table to show updated status
        }, 1500);
        return;
      }

      setTimeout(pollWorkflowStatus, 4000);
    }

    loadLibrary();
  </script>
</body>
</html>
