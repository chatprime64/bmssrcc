<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; margin: 6px 0 14px; }
    button { padding: 10px 18px; cursor: pointer; background:#4CAF50; color:white; border:none; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <form id="sheetForm" onsubmit="submitSheetForm(event)">
    <label>Member:</label>
    <select id="memberName" name="memberName" required>
      <option value="">--Select Member--</option>
    </select>

    <label>Date:</label>
    <input type="date" id="date" required />

    <label>Time Spent:</label>
    <input type="text" id="timeSpent" placeholder="e.g. 1h 30m" required />

    <label>Task:</label>
    <textarea id="task" rows="4" required></textarea>

    <button type="submit">Submit</button>
  </form>

<script>
  // -------------------------
  // COOKIE AUTH
  // -------------------------
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }

  function checkAuth() {
    const key = getCookie("githubKey");
    if (!key) {
      alert("You are not logged in. Redirecting to login...");
      window.location.href = "login.html";
    }
  }

  checkAuth();

  // -------------------------
  // LOAD MEMBERS.JSON LOCALLY
  // -------------------------
  async function loadMembers() {
    try {
      const response = await fetch("members.json");

      if (!response.ok) throw new Error("Could not load members.json");

      const members = await response.json();
      const select = document.getElementById("memberName");
      select.innerHTML = `<option value="">--Select Member--</option>`;

      members.forEach(member => {
        const option = document.createElement("option");
        option.value = member.name;
        option.textContent = member.name;
        select.appendChild(option);
      });

    } catch (err) {
      console.error("Failed to load members:", err);
    }
  }

  loadMembers();

  // -------------------------
  // SUBMIT FORM TO GITHUB API
  // -------------------------
  async function submitSheetForm(event) {
    event.preventDefault();

    const token = getCookie("githubKey");
    const repoOwner = "YOUR_USERNAME";   // <-- replace
    const repoName = "YOUR_REPO";         // <-- replace
    const filePath = "sheets.json";

    const sheet = {
      member: document.getElementById("memberName").value,
      date: document.getElementById("date").value,
      timeSpent: document.getElementById("timeSpent").value,
      task: document.getElementById("task").value,
      timestamp: new Date().toISOString()
    };

    try {
      // Fetch existing sheets.json
      const getRes = await fetch(
        `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`,
        {
          headers: { Authorization: `token ${token}` }
        }
      );

      let sha = null;
      let fileContent = [];

      if (getRes.ok) {
        const data = await getRes.json();
        sha = data.sha;
        fileContent = JSON.parse(atob(data.content));
      }

      fileContent.push(sheet);

      const updatedContent = btoa(JSON.stringify(fileContent, null, 2));

      await fetch(
        `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`,
        {
          method: "PUT",
          headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Add new sheet entry",
            content: updatedContent,
            sha: sha
          })
        }
      );

      alert("Sheet submitted successfully!");
      document.getElementById("sheetForm").reset();

    } catch (err) {
      console.error("Error submitting sheet:", err);
      alert("Error submitting sheet. Check console.");
    }
  }
</script>

</body>
</html>
